---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app.kubernetes.io/component: mon
    app.kubernetes.io/name: ceph
    app.kubernetes.io/part-of: kubernetes
  name: ceph-mon-a
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/component: mon
      app.kubernetes.io/name: ceph
      app.kubernetes.io/part-of: kubernetes
  strategy:
    rollingUpdate:
      maxSurge: 0
      maxUnavailable: 100%
  template:
    metadata:
      labels:
        app.kubernetes.io/component: mon
        app.kubernetes.io/name: ceph
        app.kubernetes.io/part-of: kubernetes
        ceph.kubernetes.progamesigner.dev/mon: a
    spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: mon.ceph.kubernetes.progamesigner.dev/a
                operator: Exists
      automountServiceAccountToken: true
      initContainers:
      - name: chown
        image: busybox:latest
        command:
        - sh
        - -c
        - |
          set -ex;

          cp -LRv /mnt/ceph/*.keyring /etc/ceph/;
          cp -LRv /mnt/ceph-conf/ceph.conf /etc/ceph/ceph.conf;

          mkdir -p /var/lib/ceph/mon/ceph-${CEPH_NAME};

          chown -R 167:167 /etc/ceph;
          chown -R 167:167 /var/lib/ceph/mon/ceph-${CEPH_NAME};
        env:
        - name: CEPH_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.labels['ceph.kubernetes.progamesigner.dev/mon']
        resources:
          requests:
            cpu: 1m
            memory: 1Mi
        volumeMounts:
        - name: ceph
          mountPath: /mnt/ceph
          readOnly: true
        - name: ceph-conf
          mountPath: /mnt/ceph-conf
          readOnly: true
        - name: conf
          mountPath: /etc/ceph
        - name: data
          mountPath: /var/lib/ceph
      - name: setup
        image: ceph/ceph:latest
        command:
        - ceph-mon
        args:
        - --id=$(CEPH_NAME)
        - --keyring=/etc/ceph/ceph.mon.keyring
        - --mkfs
        - --setgroup=ceph
        - --setuser=ceph
        env:
        - name: CEPH_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.labels['ceph.kubernetes.progamesigner.dev/mon']
        resources:
          requests:
            cpu: 1m
            memory: 1Mi
        volumeMounts:
        - name: conf
          mountPath: /etc/ceph
          readOnly: true
        - name: data
          mountPath: /var/lib/ceph
      containers:
      - name: mon
        image: ceph/ceph:latest
        command:
        - ceph-mon
        args:
        - --foreground
        - --id=$(CEPH_NAME)
        - --public-bind-addr=$(POD_IP)
        - --setgroup=ceph
        - --setuser=ceph
        env:
        - name: CEPH_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.labels['ceph.kubernetes.progamesigner.dev/mon']
        - name: POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        ports:
        - name: ceph-mon
          containerPort: 3300
          protocol: TCP
        - name: ceph-mon-v1
          containerPort: 6789
          protocol: TCP
        startupProbe:
          exec:
            command:
            - sh
            - -c
            - |
              output="$(ceph --admin-daemon /run/ceph/ceph-mon.${CEPH_NAME}.asok mon_status 2>&1)"
              rc=$?
              if [ $rc -ne 0 ]; then
                echo "ceph daemon health check failed with the following output:"
                echo "$output" | sed -e 's/^/> /g'
                exit $rc
              fi
          initialDelaySeconds: 15
          periodSeconds: 60
          timeoutSeconds: 30
        livenessProbe:
          exec:
            command:
            - sh
            - -c
            - |
              output="$(ceph --admin-daemon /run/ceph/ceph-mon.${CEPH_NAME}.asok mon_status 2>&1)"
              rc=$?
              if [ $rc -ne 0 ]; then
                echo "ceph daemon health check failed with the following output:"
                echo "$output" | sed -e 's/^/> /g'
                exit $rc
              fi
          initialDelaySeconds: 15
          periodSeconds: 60
          timeoutSeconds: 30
        resources:
          limits:
            cpu: 300m
            memory: 256Mi
          requests:
            cpu: 100m
            memory: 32Mi
        volumeMounts:
        - name: conf
          mountPath: /etc/ceph
          readOnly: true
        - name: data
          mountPath: /var/lib/ceph
      priorityClassName: system-cluster-critical
      serviceAccountName: ceph
      volumes:
      - name: ceph
        hostPath:
          path: /etc/ceph
      - name: ceph-conf
        configMap:
          name: ceph
          items:
          - key: ceph.conf
            path: ceph.conf
      - name: conf
        emptyDir: {}
      - name: data
        hostPath:
          path: /var/lib/ceph
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app.kubernetes.io/component: mon
    app.kubernetes.io/name: ceph
    app.kubernetes.io/part-of: kubernetes
  name: ceph-mon-b
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/component: mon
      app.kubernetes.io/name: ceph
      app.kubernetes.io/part-of: kubernetes
  strategy:
    rollingUpdate:
      maxSurge: 0
      maxUnavailable: 100%
  template:
    metadata:
      labels:
        app.kubernetes.io/component: mon
        app.kubernetes.io/name: ceph
        app.kubernetes.io/part-of: kubernetes
        ceph.kubernetes.progamesigner.dev/mon: b
    spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: mon.ceph.kubernetes.progamesigner.dev/b
                operator: Exists
      automountServiceAccountToken: true
      initContainers:
      - name: chown
        image: busybox:latest
        command:
        - sh
        - -c
        - |
          set -ex;

          cp -LRv /mnt/ceph/*.keyring /etc/ceph/;
          cp -LRv /mnt/ceph-conf/ceph.conf /etc/ceph/ceph.conf;

          mkdir -p /var/lib/ceph/mon/ceph-${CEPH_NAME};

          chown -R 167:167 /etc/ceph;
          chown -R 167:167 /var/lib/ceph/mon/ceph-${CEPH_NAME};
        env:
        - name: CEPH_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.labels['ceph.kubernetes.progamesigner.dev/mon']
        resources:
          requests:
            cpu: 1m
            memory: 1Mi
        volumeMounts:
        - name: ceph
          mountPath: /mnt/ceph
          readOnly: true
        - name: ceph-conf
          mountPath: /mnt/ceph-conf
          readOnly: true
        - name: conf
          mountPath: /etc/ceph
      - name: setup
        image: ceph/ceph:latest
        command:
        - ceph-mon
        args:
        - --id=$(CEPH_NAME)
        - --keyring=/etc/ceph/ceph.mon.keyring
        - --mkfs
        - --setgroup=ceph
        - --setuser=ceph
        env:
        - name: CEPH_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.labels['ceph.kubernetes.progamesigner.dev/mon']
        resources:
          requests:
            cpu: 1m
            memory: 1Mi
        volumeMounts:
        - name: conf
          mountPath: /etc/ceph
          readOnly: true
        - name: data
          mountPath: /var/lib/ceph
      containers:
      - name: mon
        image: ceph/ceph:latest
        command:
        - ceph-mon
        args:
        - --foreground
        - --id=$(CEPH_NAME)
        - --public-bind-addr=$(POD_IP)
        - --setgroup=ceph
        - --setuser=ceph
        env:
        - name: CEPH_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.labels['ceph.kubernetes.progamesigner.dev/mon']
        - name: POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        ports:
        - name: ceph-mon
          containerPort: 3300
          protocol: TCP
        - name: ceph-mon-v1
          containerPort: 6789
          protocol: TCP
        startupProbe:
          exec:
            command:
            - sh
            - -c
            - |
              output="$(ceph --admin-daemon /run/ceph/ceph-mon.${CEPH_NAME}.asok mon_status 2>&1)"
              rc=$?
              if [ $rc -ne 0 ]; then
                echo "ceph daemon health check failed with the following output:"
                echo "$output" | sed -e 's/^/> /g'
                exit $rc
              fi
          initialDelaySeconds: 15
          periodSeconds: 60
          timeoutSeconds: 30
        livenessProbe:
          exec:
            command:
            - sh
            - -c
            - |
              output="$(ceph --admin-daemon /run/ceph/ceph-mon.${CEPH_NAME}.asok mon_status 2>&1)"
              rc=$?
              if [ $rc -ne 0 ]; then
                echo "ceph daemon health check failed with the following output:"
                echo "$output" | sed -e 's/^/> /g'
                exit $rc
              fi
          initialDelaySeconds: 15
          periodSeconds: 60
          timeoutSeconds: 30
        resources:
          limits:
            cpu: 300m
            memory: 256Mi
          requests:
            cpu: 100m
            memory: 32Mi
        volumeMounts:
        - name: conf
          mountPath: /etc/ceph
          readOnly: true
        - name: data
          mountPath: /var/lib/ceph
      priorityClassName: system-cluster-critical
      serviceAccountName: ceph
      volumes:
      - name: ceph
        hostPath:
          path: /etc/ceph
      - name: ceph-conf
        configMap:
          name: ceph
          items:
          - key: ceph.conf
            path: ceph.conf
      - name: conf
        emptyDir: {}
      - name: data
        hostPath:
          path: /var/lib/ceph
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app.kubernetes.io/component: mon
    app.kubernetes.io/name: ceph
    app.kubernetes.io/part-of: kubernetes
  name: ceph-mon-c
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/component: mon
      app.kubernetes.io/name: ceph
      app.kubernetes.io/part-of: kubernetes
  strategy:
    rollingUpdate:
      maxSurge: 0
      maxUnavailable: 100%
  template:
    metadata:
      labels:
        app.kubernetes.io/component: mon
        app.kubernetes.io/name: ceph
        app.kubernetes.io/part-of: kubernetes
        ceph.kubernetes.progamesigner.dev/mon: c
    spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: mon.ceph.kubernetes.progamesigner.dev/c
                operator: Exists
      automountServiceAccountToken: true
      initContainers:
      - name: chown
        image: busybox:latest
        command:
        - sh
        - -c
        - |
          set -ex;

          cp -LRv /mnt/ceph/*.keyring /etc/ceph/;
          cp -LRv /mnt/ceph-conf/ceph.conf /etc/ceph/ceph.conf;

          mkdir -p /var/lib/ceph/mon/ceph-${CEPH_NAME};

          chown -R 167:167 /etc/ceph;
          chown -R 167:167 /var/lib/ceph/mon/ceph-${CEPH_NAME};
        env:
        - name: CEPH_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.labels['ceph.kubernetes.progamesigner.dev/mon']
        resources:
          requests:
            cpu: 1m
            memory: 1Mi
        volumeMounts:
        - name: ceph
          mountPath: /mnt/ceph
          readOnly: true
        - name: ceph-conf
          mountPath: /mnt/ceph-conf
          readOnly: true
        - name: conf
          mountPath: /etc/ceph
      - name: setup
        image: ceph/ceph:latest
        command:
        - ceph-mon
        args:
        - --id=$(CEPH_NAME)
        - --keyring=/etc/ceph/ceph.mon.keyring
        - --mkfs
        - --setgroup=ceph
        - --setuser=ceph
        env:
        - name: CEPH_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.labels['ceph.kubernetes.progamesigner.dev/mon']
        resources:
          requests:
            cpu: 1m
            memory: 1Mi
        volumeMounts:
        - name: conf
          mountPath: /etc/ceph
          readOnly: true
        - name: data
          mountPath: /var/lib/ceph
      containers:
      - name: mon
        image: ceph/ceph:latest
        command:
        - ceph-mon
        args:
        - --foreground
        - --id=$(CEPH_NAME)
        - --public-bind-addr=$(POD_IP)
        - --setgroup=ceph
        - --setuser=ceph
        env:
        - name: CEPH_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.labels['ceph.kubernetes.progamesigner.dev/mon']
        - name: POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        ports:
        - name: ceph-mon
          containerPort: 3300
          protocol: TCP
        - name: ceph-mon-v1
          containerPort: 6789
          protocol: TCP
        startupProbe:
          exec:
            command:
            - sh
            - -c
            - |
              output="$(ceph --admin-daemon /run/ceph/ceph-mon.${CEPH_NAME}.asok mon_status 2>&1)"
              rc=$?
              if [ $rc -ne 0 ]; then
                echo "ceph daemon health check failed with the following output:"
                echo "$output" | sed -e 's/^/> /g'
                exit $rc
              fi
          initialDelaySeconds: 15
          periodSeconds: 60
          timeoutSeconds: 30
        livenessProbe:
          exec:
            command:
            - sh
            - -c
            - |
              output="$(ceph --admin-daemon /run/ceph/ceph-mon.${CEPH_NAME}.asok mon_status 2>&1)"
              rc=$?
              if [ $rc -ne 0 ]; then
                echo "ceph daemon health check failed with the following output:"
                echo "$output" | sed -e 's/^/> /g'
                exit $rc
              fi
          initialDelaySeconds: 15
          periodSeconds: 60
          timeoutSeconds: 30
        resources:
          limits:
            cpu: 300m
            memory: 256Mi
          requests:
            cpu: 100m
            memory: 32Mi
        volumeMounts:
        - name: conf
          mountPath: /etc/ceph
          readOnly: true
        - name: data
          mountPath: /var/lib/ceph
      priorityClassName: system-cluster-critical
      serviceAccountName: ceph
      volumes:
      - name: ceph
        hostPath:
          path: /etc/ceph
      - name: ceph-conf
        configMap:
          name: ceph
          items:
          - key: ceph.conf
            path: ceph.conf
      - name: conf
        emptyDir: {}
      - name: data
        hostPath:
          path: /var/lib/ceph
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app.kubernetes.io/component: mgr
    app.kubernetes.io/name: ceph
    app.kubernetes.io/part-of: kubernetes
  name: ceph-mgr-a
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/component: mgr
      app.kubernetes.io/name: ceph
      app.kubernetes.io/part-of: kubernetes
  template:
    metadata:
      labels:
        app.kubernetes.io/component: mgr
        app.kubernetes.io/name: ceph
        app.kubernetes.io/part-of: kubernetes
        ceph.kubernetes.progamesigner.dev/mgr: a
    spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: mgr.ceph.kubernetes.progamesigner.dev/a
                operator: Exists
      automountServiceAccountToken: true
      initContainers:
      - name: chown
        image: busybox:latest
        command:
        - sh
        - -c
        - |
          set -ex;

          cp -LRv /mnt/ceph/*.keyring /etc/ceph/;
          cp -LRv /mnt/ceph-conf/ceph.conf /etc/ceph/ceph.conf;

          mkdir -p /var/lib/ceph/mgr/ceph-${CEPH_NAME};

          chown -R 167:167 /etc/ceph;
          chown -R 167:167 /var/lib/ceph/mgr/ceph-${CEPH_NAME};
        env:
        - name: CEPH_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.labels['ceph.kubernetes.progamesigner.dev/mgr']
        resources:
          requests:
            cpu: 1m
            memory: 1Mi
        volumeMounts:
        - name: ceph
          mountPath: /mnt/ceph
          readOnly: true
        - name: ceph-conf
          mountPath: /mnt/ceph-conf
          readOnly: true
        - name: conf
          mountPath: /etc/ceph
        - name: data
          mountPath: /var/lib/ceph
      - name: setup
        image: ceph/ceph:latest
        command:
        - sh
        - -c
        - |
          set -ex;

          while ! ceph mon dump; do
            echo "Waiting for mon to be ready ...";
            sleep 5;
          done

          if [ ! -f /var/lib/ceph/mgr/ceph-${CEPH_NAME}/keyring ]; then
            ceph auth add mgr.$(CEPH_NAME) mon 'allow profile mgr' osd 'allow *' mds 'allow *';
            ceph auth get mgr.$(CEPH_NAME) > /var/lib/ceph/mgr/ceph-${CEPH_NAME}/keyring;
          fi
        env:
        - name: CEPH_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.labels['ceph.kubernetes.progamesigner.dev/mgr']
        resources:
          requests:
            cpu: 1m
            memory: 1Mi
        volumeMounts:
        - name: conf
          mountPath: /etc/ceph
          readOnly: true
        - name: data
          mountPath: /var/lib/ceph
      containers:
      - name: mgr
        image: ceph/ceph:latest
        command:
        - ceph-mgr
        args:
        - --foreground
        - --id=$(CEPH_NAME)
        - --setgroup=ceph
        - --setuser=ceph
        env:
        - name: CEPH_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.labels['ceph.kubernetes.progamesigner.dev/mgr']
        ports:
        - name: https
          containerPort: 8443
          protocol: TCP
        resources:
          limits:
            cpu: 300m
            memory: 2Gi
          requests:
            cpu: 100m
            memory: 256Mi
        volumeMounts:
        - name: conf
          mountPath: /etc/ceph
          readOnly: true
        - name: data
          mountPath: /var/lib/ceph
      priorityClassName: system-cluster-critical
      serviceAccountName: ceph
      volumes:
      - name: ceph
        hostPath:
          path: /etc/ceph
      - name: ceph-conf
        configMap:
          name: ceph
          items:
          - key: ceph.conf
            path: ceph.conf
      - name: conf
        emptyDir: {}
      - name: data
        hostPath:
          path: /var/lib/ceph
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app.kubernetes.io/component: mgr
    app.kubernetes.io/name: ceph
    app.kubernetes.io/part-of: kubernetes
  name: ceph-mgr-b
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/component: mgr
      app.kubernetes.io/name: ceph
      app.kubernetes.io/part-of: kubernetes
  template:
    metadata:
      labels:
        app.kubernetes.io/component: mgr
        app.kubernetes.io/name: ceph
        app.kubernetes.io/part-of: kubernetes
        ceph.kubernetes.progamesigner.dev/mgr: b
    spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: mgr.ceph.kubernetes.progamesigner.dev/b
                operator: Exists
      automountServiceAccountToken: true
      initContainers:
      - name: chown
        image: busybox:latest
        command:
        - sh
        - -c
        - |
          set -ex;

          cp -LRv /mnt/ceph/*.keyring /etc/ceph/;
          cp -LRv /mnt/ceph-conf/ceph.conf /etc/ceph/ceph.conf;

          mkdir -p /var/lib/ceph/mgr/ceph-${CEPH_NAME};

          chown -R 167:167 /etc/ceph;
          chown -R 167:167 /var/lib/ceph/mgr/ceph-${CEPH_NAME};
        env:
        - name: CEPH_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.labels['ceph.kubernetes.progamesigner.dev/mgr']
        resources:
          requests:
            cpu: 1m
            memory: 1Mi
        volumeMounts:
        - name: ceph
          mountPath: /mnt/ceph
          readOnly: true
        - name: ceph-conf
          mountPath: /mnt/ceph-conf
          readOnly: true
        - name: conf
          mountPath: /etc/ceph
        - name: data
          mountPath: /var/lib/ceph
      - name: setup
        image: ceph/ceph:latest
        command:
        - sh
        - -c
        - |
          set -ex;

          while ! ceph mon dump; do
            echo "Waiting for mon to be ready ...";
            sleep 5;
          done

          if [ ! -f /var/lib/ceph/mgr/ceph-${CEPH_NAME}/keyring ]; then
            ceph auth add mgr.$(CEPH_NAME) mon 'allow profile mgr' osd 'allow *' mds 'allow *';
            ceph auth get mgr.$(CEPH_NAME) > /var/lib/ceph/mgr/ceph-${CEPH_NAME}/keyring;
          fi
        env:
        - name: CEPH_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.labels['ceph.kubernetes.progamesigner.dev/mgr']
        resources:
          requests:
            cpu: 1m
            memory: 1Mi
        volumeMounts:
        - name: conf
          mountPath: /etc/ceph
          readOnly: true
        - name: data
          mountPath: /var/lib/ceph
      containers:
      - name: mgr
        image: ceph/ceph:latest
        command:
        - ceph-mgr
        args:
        - --foreground
        - --id=$(CEPH_NAME)
        - --setgroup=ceph
        - --setuser=ceph
        env:
        - name: CEPH_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.labels['ceph.kubernetes.progamesigner.dev/mgr']
        ports:
        - name: http
          containerPort: 8443
          protocol: TCP
        resources:
          limits:
            cpu: 300m
            memory: 2Gi
          requests:
            cpu: 100m
            memory: 256Mi
        volumeMounts:
        - name: conf
          mountPath: /etc/ceph
          readOnly: true
        - name: data
          mountPath: /var/lib/ceph
      priorityClassName: system-cluster-critical
      serviceAccountName: ceph
      volumes:
      - name: ceph
        hostPath:
          path: /etc/ceph
      - name: ceph-conf
        configMap:
          name: ceph
          items:
          - key: ceph.conf
            path: ceph.conf
      - name: conf
        emptyDir: {}
      - name: data
        hostPath:
          path: /var/lib/ceph
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app.kubernetes.io/component: mds
    app.kubernetes.io/name: ceph
    app.kubernetes.io/part-of: kubernetes
  name: ceph-mds-a
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/component: mds
      app.kubernetes.io/name: ceph
      app.kubernetes.io/part-of: kubernetes
  template:
    metadata:
      labels:
        app.kubernetes.io/component: mds
        app.kubernetes.io/name: ceph
        app.kubernetes.io/part-of: kubernetes
        ceph.kubernetes.progamesigner.dev/mds: a
    spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: mds.ceph.kubernetes.progamesigner.dev/a
                operator: Exists
      automountServiceAccountToken: true
      initContainers:
      - name: chown
        image: busybox:latest
        command:
        - sh
        - -c
        - |
          set -ex;

          cp -LRv /mnt/ceph/*.keyring /etc/ceph/;
          cp -LRv /mnt/ceph-conf/ceph.conf /etc/ceph/ceph.conf;

          mkdir -p /var/lib/ceph/mds/ceph-${CEPH_NAME};

          chown -R 167:167 /etc/ceph;
          chown -R 167:167 /var/lib/ceph/mds/ceph-${CEPH_NAME};
        env:
        - name: CEPH_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.labels['ceph.kubernetes.progamesigner.dev/mds']
        resources:
          requests:
            cpu: 1m
            memory: 1Mi
        volumeMounts:
        - name: ceph
          mountPath: /mnt/ceph
          readOnly: true
        - name: ceph-conf
          mountPath: /mnt/ceph-conf
          readOnly: true
        - name: conf
          mountPath: /etc/ceph
        - name: data
          mountPath: /var/lib/ceph
      - name: setup
        image: ceph/ceph:latest
        command:
        - sh
        - -c
        - |
          set -ex;

          while ! ceph mon dump; do
            echo "Waiting for mon to be ready ...";
            sleep 5;
          done

          if [ ! -f /var/lib/ceph/mds/ceph-${CEPH_NAME}/keyring ]; then
            ceph-authtool --create-keyring /var/lib/ceph/mds/ceph-${CEPH_NAME}/keyring --gen-key -n mds.${CEPH_NAME};
            sleep 5;
            ceph auth add mds.${CEPH_NAME} osd "allow rwx" mds "allow *" mon "allow profile mds" -i /var/lib/ceph/mds/ceph-${CEPH_NAME}/keyring;
            chown -R 167:167 /var/lib/ceph/mds/ceph-${CEPH_NAME};
          fi
        env:
        - name: CEPH_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.labels['ceph.kubernetes.progamesigner.dev/mds']
        resources:
          requests:
            cpu: 1m
            memory: 1Mi
        volumeMounts:
        - name: conf
          mountPath: /etc/ceph
          readOnly: true
        - name: data
          mountPath: /var/lib/ceph
      containers:
      - name: mds
        image: ceph/ceph:latest
        command:
        - ceph-mds
        args:
        - --foreground
        - --id=$(CEPH_NAME)
        - --setgroup=ceph
        - --setuser=ceph
        env:
        - name: CEPH_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.labels['ceph.kubernetes.progamesigner.dev/mds']
        ports:
        - name: https
          containerPort: 8443
          protocol: TCP
        resources:
          limits:
            cpu: 300m
            memory: 2Gi
          requests:
            cpu: 100m
            memory: 256Mi
        volumeMounts:
        - name: conf
          mountPath: /etc/ceph
          readOnly: true
        - name: data
          mountPath: /var/lib/ceph
      priorityClassName: system-cluster-critical
      serviceAccountName: ceph
      volumes:
      - name: ceph
        hostPath:
          path: /etc/ceph
      - name: ceph-conf
        configMap:
          name: ceph
          items:
          - key: ceph.conf
            path: ceph.conf
      - name: conf
        emptyDir: {}
      - name: data
        hostPath:
          path: /var/lib/ceph
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app.kubernetes.io/component: mds
    app.kubernetes.io/name: ceph
    app.kubernetes.io/part-of: kubernetes
  name: ceph-mds-b
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/component: mds
      app.kubernetes.io/name: ceph
      app.kubernetes.io/part-of: kubernetes
  template:
    metadata:
      labels:
        app.kubernetes.io/component: mds
        app.kubernetes.io/name: ceph
        app.kubernetes.io/part-of: kubernetes
        ceph.kubernetes.progamesigner.dev/mds: b
    spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: mds.ceph.kubernetes.progamesigner.dev/b
                operator: Exists
      automountServiceAccountToken: true
      initContainers:
      - name: chown
        image: busybox:latest
        command:
        - sh
        - -c
        - |
          set -ex;

          cp -LRv /mnt/ceph/*.keyring /etc/ceph/;
          cp -LRv /mnt/ceph-conf/ceph.conf /etc/ceph/ceph.conf;

          mkdir -p /var/lib/ceph/mds/ceph-${CEPH_NAME};

          chown -R 167:167 /etc/ceph;
          chown -R 167:167 /var/lib/ceph/mds/ceph-${CEPH_NAME};
        env:
        - name: CEPH_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.labels['ceph.kubernetes.progamesigner.dev/mds']
        resources:
          requests:
            cpu: 1m
            memory: 1Mi
        volumeMounts:
        - name: ceph
          mountPath: /mnt/ceph
          readOnly: true
        - name: ceph-conf
          mountPath: /mnt/ceph-conf
          readOnly: true
        - name: conf
          mountPath: /etc/ceph
        - name: data
          mountPath: /var/lib/ceph
      - name: setup
        image: ceph/ceph:latest
        command:
        - sh
        - -c
        - |
          set -ex;

          while ! ceph mon dump; do
            echo "Waiting for mon to be ready ...";
            sleep 5;
          done

          if [ ! -f /var/lib/ceph/mds/ceph-${CEPH_NAME}/keyring ]; then
            ceph-authtool --create-keyring /var/lib/ceph/mds/ceph-${CEPH_NAME}/keyring --gen-key -n mds.${CEPH_NAME};
            sleep 5;
            ceph auth add mds.${CEPH_NAME} osd "allow rwx" mds "allow *" mon "allow profile mds" -i /var/lib/ceph/mds/ceph-${CEPH_NAME}/keyring;
            chown -R 167:167 /var/lib/ceph/mds/ceph-${CEPH_NAME};
          fi
        env:
        - name: CEPH_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.labels['ceph.kubernetes.progamesigner.dev/mds']
        resources:
          requests:
            cpu: 1m
            memory: 1Mi
        volumeMounts:
        - name: conf
          mountPath: /etc/ceph
          readOnly: true
        - name: data
          mountPath: /var/lib/ceph
      containers:
      - name: mds
        image: ceph/ceph:latest
        command:
        - ceph-mds
        args:
        - --foreground
        - --id=$(CEPH_NAME)
        - --setgroup=ceph
        - --setuser=ceph
        env:
        - name: CEPH_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.labels['ceph.kubernetes.progamesigner.dev/mds']
        ports:
        - name: https
          containerPort: 8443
          protocol: TCP
        resources:
          limits:
            cpu: 300m
            memory: 2Gi
          requests:
            cpu: 100m
            memory: 256Mi
        volumeMounts:
        - name: conf
          mountPath: /etc/ceph
          readOnly: true
        - name: data
          mountPath: /var/lib/ceph
      priorityClassName: system-cluster-critical
      serviceAccountName: ceph
      volumes:
      - name: ceph
        hostPath:
          path: /etc/ceph
      - name: ceph-conf
        configMap:
          name: ceph
          items:
          - key: ceph.conf
            path: ceph.conf
      - name: conf
        emptyDir: {}
      - name: data
        hostPath:
          path: /var/lib/ceph
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app.kubernetes.io/component: radosgw
    app.kubernetes.io/name: ceph
    app.kubernetes.io/part-of: kubernetes
  name: ceph-radosgw
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/component: radosgw
      app.kubernetes.io/name: ceph
      app.kubernetes.io/part-of: kubernetes
  template:
    metadata:
      labels:
        app.kubernetes.io/component: radosgw
        app.kubernetes.io/name: ceph
        app.kubernetes.io/part-of: kubernetes
    spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: ceph.kubernetes.progamesigner.dev/radosgw
                operator: Exists
      automountServiceAccountToken: true
      initContainers:
      - name: chown
        image: busybox:latest
        command:
        - sh
        - -c
        - |
          set -ex;

          cp -LRv /mnt/ceph/*.keyring /etc/ceph/;
          cp -LRv /mnt/ceph-conf/ceph.conf /etc/ceph/ceph.conf;

          mkdir -p /var/lib/ceph/radosgw/ceph-${CEPH_NAME};

          chown -R 167:167 /etc/ceph;
          chown -R 167:167 /var/lib/ceph/radosgw/ceph-${CEPH_NAME};
        env:
        - name: CEPH_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        resources:
          requests:
            cpu: 1m
            memory: 1Mi
        volumeMounts:
        - name: ceph
          mountPath: /mnt/ceph
          readOnly: true
        - name: ceph-conf
          mountPath: /mnt/ceph-conf
          readOnly: true
        - name: conf
          mountPath: /etc/ceph
        - name: data
          mountPath: /var/lib/ceph
      - name: setup
        image: ceph/ceph:latest
        command:
        - sh
        - -c
        - |
          set -ex;

          while ! ceph mon dump; do
            echo "Waiting for mon to be ready ...";
            sleep 5;
          done

          if [ ! -f /var/lib/ceph/radosgw/ceph-${CEPH_NAME}/keyring ]; then
            ceph-authtool --create-keyring /var/lib/ceph/radosgw/ceph-${CEPH_NAME}/keyring --gen-key -n client.${CEPH_NAME};
            sleep 5;
            ceph auth add client.${CEPH_NAME} mon 'allow rw' osd 'allow rwx' -i /var/lib/ceph/radosgw/ceph-${CEPH_NAME}/keyring;
            chown -R 167:167 /var/lib/ceph/radosgw/ceph-${CEPH_NAME};
          fi
        env:
        - name: CEPH_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        resources:
          requests:
            cpu: 1m
            memory: 1Mi
        volumeMounts:
        - name: conf
          mountPath: /etc/ceph
          readOnly: true
        - name: data
          mountPath: /var/lib/ceph
      containers:
      - name: radosgw
        image: ceph/ceph:latest
        command:
        - radosgw
        args:
        - --foreground
        - --id=$(CEPH_NAME)
        - --setgroup=ceph
        - --setuser=ceph
        env:
        - name: CEPH_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        ports:
        - name: https
          containerPort: 8443
          protocol: TCP
        resources:
          limits:
            cpu: 300m
            memory: 2Gi
          requests:
            cpu: 100m
            memory: 256Mi
        volumeMounts:
        - name: conf
          mountPath: /etc/ceph
          readOnly: true
        - name: data
          mountPath: /var/lib/ceph
      priorityClassName: system-cluster-critical
      serviceAccountName: ceph
      volumes:
      - name: ceph
        hostPath:
          path: /etc/ceph
      - name: ceph-conf
        configMap:
          name: ceph
          items:
          - key: ceph.conf
            path: ceph.conf
      - name: conf
        emptyDir: {}
      - name: data
        hostPath:
          path: /var/lib/ceph
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app.kubernetes.io/component: osd
    app.kubernetes.io/name: ceph
    app.kubernetes.io/part-of: kubernetes
  name: ceph-osd-24
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/component: osd
      app.kubernetes.io/name: ceph
      app.kubernetes.io/part-of: kubernetes
  template:
    metadata:
      annotations:
        ceph.kubernetes.progamesigner.dev/osd-lvm-lg: ceph-osd24-lv
        ceph.kubernetes.progamesigner.dev/osd-lvm-vg: ceph-vg
      labels:
        app.kubernetes.io/component: osd
        app.kubernetes.io/name: ceph
        app.kubernetes.io/part-of: kubernetes
        ceph.kubernetes.progamesigner.dev/osd: '27'
    spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: osd.ceph.kubernetes.progamesigner.dev/24
                operator: Exists
      automountServiceAccountToken: true
      hostIPC: true
      initContainers:
      - name: chown
        image: busybox:latest
        command:
        - sh
        - -c
        - |
          set -ex;

          cp -LRv /mnt/ceph/*.keyring /etc/ceph/;
          cp -LRv /mnt/ceph-conf/ceph.conf /etc/ceph/ceph.conf;

          mkdir -p /var/lib/ceph/osd/ceph-${CEPH_NAME};

          chown -R 167:167 /etc/ceph;
          chown -R 167:167 /var/lib/ceph/osd/ceph-${CEPH_NAME};
        env:
        - name: CEPH_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.labels['ceph.kubernetes.progamesigner.dev/osd']
        resources:
          requests:
            cpu: 1m
            memory: 1Mi
        volumeMounts:
        - name: ceph
          mountPath: /mnt/ceph
          readOnly: true
        - name: ceph-conf
          mountPath: /mnt/ceph-conf
          readOnly: true
        - name: conf
          mountPath: /etc/ceph
        - name: data
          mountPath: /var/lib/ceph
      - name: setup
        image: ceph/ceph:latest
        command:
        - sh
        - -c
        - |
          set -ex;

          while ! ceph mon dump; do
            echo "Waiting for mon to be ready ...";
            sleep 5;
          done

          if [ ! -f /var/lib/ceph/osd/ceph-${CEPH_NAME}/fsid ]; then
            ceph-volume lvm prepare --data ${CEPH_LVM_VG}/${CEPH_LVM_LG} --dmcrypt --osd-id ${CEPH_NAME} --no-systemd;
            sleep 5;
            echo $(ceph-volume lvm list --format json | jq -r --arg osd "${CEPH_NAME}" 'getpath([$osd,0,"tags","ceph.osd_fsid"])') > /var/lib/ceph/osd/ceph-${CEPH_NAME}/fsid;
          fi
        env:
        - name: CEPH_LVM_LG
          valueFrom:
            fieldRef:
              fieldPath: metadata.annotations['ceph.kubernetes.progamesigner.dev/osd-lvm-lg']
        - name: CEPH_LVM_VG
          valueFrom:
            fieldRef:
              fieldPath: metadata.annotations['ceph.kubernetes.progamesigner.dev/osd-lvm-vg']
        - name: CEPH_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.labels['ceph.kubernetes.progamesigner.dev/osd']
        resources:
          requests:
            cpu: 1000m
            memory: 2Gi
        securityContext:
          privileged: true
        volumeMounts:
        - name: conf
          mountPath: /etc/ceph
          readOnly: true
        - name: data
          mountPath: /var/lib/ceph
        - name: dev
          mountPath: /dev
        - name: run-ceph
          mountPath: /run/ceph
        - name: run-lvm
          mountPath: /run/lvm
        - name: run-udev
          mountPath: /run/udev
      containers:
      - name: osd
        image: ceph/ceph:latest
        command:
        - sh
        - -c
        - |
          set -ex;

          CEPH_FSID=$(cat /var/lib/ceph/osd/ceph-${CEPH_NAME}/fsid);

          ceph-volume lvm activate ${CEPH_NAME} ${CEPH_FSID} --no-systemd;

          exec ceph-osd --foreground --id=${CEPH_NAME} --setgroup=ceph --setuser=ceph;
        env:
        - name: CEPH_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.labels['ceph.kubernetes.progamesigner.dev/osd']
        resources:
          limits:
            cpu: 300m
            memory: 16Gi
          requests:
            cpu: 100m
            memory: 2Gi
        securityContext:
          privileged: true
        volumeMounts:
        - name: conf
          mountPath: /etc/ceph
          readOnly: true
        - name: data
          mountPath: /var/lib/ceph
        - name: dev
          mountPath: /dev
        - name: run-lvm
          mountPath: /run/lvm
      priorityClassName: system-cluster-critical
      serviceAccountName: ceph
      volumes:
      - name: ceph
        hostPath:
          path: /etc/ceph
      - name: ceph-conf
        configMap:
          name: ceph
          items:
          - key: ceph.conf
            path: ceph.conf
      - name: conf
        emptyDir: {}
      - name: data
        hostPath:
          path: /var/lib/ceph
      - name: dev
        hostPath:
          path: /dev
      - name: run-ceph
        emptyDir: {}
      - name: run-lvm
        hostPath:
          path: /run/lvm
      - name: run-udev
        hostPath:
          path: /run/udev
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app.kubernetes.io/component: osd
    app.kubernetes.io/name: ceph
    app.kubernetes.io/part-of: kubernetes
  name: ceph-osd-24a
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/component: osd
      app.kubernetes.io/name: ceph
      app.kubernetes.io/part-of: kubernetes
  template:
    metadata:
      annotations:
        ceph.kubernetes.progamesigner.dev/osd-lvm-lg: ceph-osd24a-lv
        ceph.kubernetes.progamesigner.dev/osd-lvm-vg: ceph-vg
      labels:
        app.kubernetes.io/component: osd
        app.kubernetes.io/name: ceph
        app.kubernetes.io/part-of: kubernetes
        ceph.kubernetes.progamesigner.dev/osd: '26'
    spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: osd.ceph.kubernetes.progamesigner.dev/24a
                operator: Exists
      automountServiceAccountToken: true
      hostIPC: true
      initContainers:
      - name: chown
        image: busybox:latest
        command:
        - sh
        - -c
        - |
          set -ex;

          cp -LRv /mnt/ceph/*.keyring /etc/ceph/;
          cp -LRv /mnt/ceph-conf/ceph.conf /etc/ceph/ceph.conf;

          mkdir -p /var/lib/ceph/osd/ceph-${CEPH_NAME};

          chown -R 167:167 /etc/ceph;
          chown -R 167:167 /var/lib/ceph/osd/ceph-${CEPH_NAME};
        env:
        - name: CEPH_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.labels['ceph.kubernetes.progamesigner.dev/osd']
        resources:
          requests:
            cpu: 1m
            memory: 1Mi
        volumeMounts:
        - name: ceph
          mountPath: /mnt/ceph
          readOnly: true
        - name: ceph-conf
          mountPath: /mnt/ceph-conf
          readOnly: true
        - name: conf
          mountPath: /etc/ceph
        - name: data
          mountPath: /var/lib/ceph
      - name: setup
        image: ceph/ceph:latest
        command:
        - sh
        - -c
        - |
          set -ex;

          while ! ceph mon dump; do
            echo "Waiting for mon to be ready ...";
            sleep 5;
          done

          if [ ! -f /var/lib/ceph/osd/ceph-${CEPH_NAME}/fsid ]; then
            ceph-volume lvm prepare --data ${CEPH_LVM_VG}/${CEPH_LVM_LG} --dmcrypt --osd-id ${CEPH_NAME} --no-systemd;
            sleep 5;
            echo $(ceph-volume lvm list --format json | jq -r --arg osd "${CEPH_NAME}" 'getpath([$osd,0,"tags","ceph.osd_fsid"])') > /var/lib/ceph/osd/ceph-${CEPH_NAME}/fsid;
          fi
        env:
        - name: CEPH_LVM_LG
          valueFrom:
            fieldRef:
              fieldPath: metadata.annotations['ceph.kubernetes.progamesigner.dev/osd-lvm-lg']
        - name: CEPH_LVM_VG
          valueFrom:
            fieldRef:
              fieldPath: metadata.annotations['ceph.kubernetes.progamesigner.dev/osd-lvm-vg']
        - name: CEPH_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.labels['ceph.kubernetes.progamesigner.dev/osd']
        resources:
          requests:
            cpu: 1000m
            memory: 2Gi
        securityContext:
          privileged: true
        volumeMounts:
        - name: conf
          mountPath: /etc/ceph
          readOnly: true
        - name: data
          mountPath: /var/lib/ceph
        - name: dev
          mountPath: /dev
        - name: run-ceph
          mountPath: /run/ceph
        - name: run-lvm
          mountPath: /run/lvm
        - name: run-udev
          mountPath: /run/udev
      containers:
      - name: osd
        image: ceph/ceph:latest
        command:
        - sh
        - -c
        - |
          set -ex;

          CEPH_FSID=$(cat /var/lib/ceph/osd/ceph-${CEPH_NAME}/fsid);

          ceph-volume lvm activate ${CEPH_NAME} ${CEPH_FSID} --no-systemd;

          exec ceph-osd --foreground --id=${CEPH_NAME} --setgroup=ceph --setuser=ceph;
        env:
        - name: CEPH_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.labels['ceph.kubernetes.progamesigner.dev/osd']
        resources:
          limits:
            cpu: 300m
            memory: 8Gi
          requests:
            cpu: 100m
            memory: 2Gi
        securityContext:
          privileged: true
        volumeMounts:
        - name: conf
          mountPath: /etc/ceph
          readOnly: true
        - name: data
          mountPath: /var/lib/ceph
        - name: dev
          mountPath: /dev
        - name: run-lvm
          mountPath: /run/lvm
      priorityClassName: system-cluster-critical
      serviceAccountName: ceph
      volumes:
      - name: ceph
        hostPath:
          path: /etc/ceph
      - name: ceph-conf
        configMap:
          name: ceph
          items:
          - key: ceph.conf
            path: ceph.conf
      - name: conf
        emptyDir: {}
      - name: data
        hostPath:
          path: /var/lib/ceph
      - name: dev
        hostPath:
          path: /dev
      - name: run-ceph
        emptyDir: {}
      - name: run-lvm
        hostPath:
          path: /run/lvm
      - name: run-udev
        hostPath:
          path: /run/udev
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app.kubernetes.io/component: osd
    app.kubernetes.io/name: ceph
    app.kubernetes.io/part-of: kubernetes
  name: ceph-osd-27
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/component: osd
      app.kubernetes.io/name: ceph
      app.kubernetes.io/part-of: kubernetes
  template:
    metadata:
      annotations:
        ceph.kubernetes.progamesigner.dev/osd-lvm-lg: ceph-osd27-lv
        ceph.kubernetes.progamesigner.dev/osd-lvm-vg: ceph-vg
      labels:
        app.kubernetes.io/component: osd
        app.kubernetes.io/name: ceph
        app.kubernetes.io/part-of: kubernetes
        ceph.kubernetes.progamesigner.dev/osd: '30'
    spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: osd.ceph.kubernetes.progamesigner.dev/27
                operator: Exists
      automountServiceAccountToken: true
      hostIPC: true
      initContainers:
      - name: chown
        image: busybox:latest
        command:
        - sh
        - -c
        - |
          set -ex;

          cp -LRv /mnt/ceph/*.keyring /etc/ceph/;
          cp -LRv /mnt/ceph-conf/ceph.conf /etc/ceph/ceph.conf;

          mkdir -p /var/lib/ceph/osd/ceph-${CEPH_NAME};

          chown -R 167:167 /etc/ceph;
          chown -R 167:167 /var/lib/ceph/osd/ceph-${CEPH_NAME};
        env:
        - name: CEPH_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.labels['ceph.kubernetes.progamesigner.dev/osd']
        resources:
          requests:
            cpu: 1m
            memory: 1Mi
        volumeMounts:
        - name: ceph
          mountPath: /mnt/ceph
          readOnly: true
        - name: ceph-conf
          mountPath: /mnt/ceph-conf
          readOnly: true
        - name: conf
          mountPath: /etc/ceph
        - name: data
          mountPath: /var/lib/ceph
      - name: setup
        image: ceph/ceph:latest
        command:
        - sh
        - -c
        - |
          set -ex;

          while ! ceph mon dump; do
            echo "Waiting for mon to be ready ...";
            sleep 5;
          done

          if [ ! -f /var/lib/ceph/osd/ceph-${CEPH_NAME}/fsid ]; then
            ceph-volume lvm prepare --data ${CEPH_LVM_VG}/${CEPH_LVM_LG} --dmcrypt --osd-id ${CEPH_NAME} --no-systemd;
            sleep 5;
            echo $(ceph-volume lvm list --format json | jq -r --arg osd "${CEPH_NAME}" 'getpath([$osd,0,"tags","ceph.osd_fsid"])') > /var/lib/ceph/osd/ceph-${CEPH_NAME}/fsid;
          fi
        env:
        - name: CEPH_LVM_LG
          valueFrom:
            fieldRef:
              fieldPath: metadata.annotations['ceph.kubernetes.progamesigner.dev/osd-lvm-lg']
        - name: CEPH_LVM_VG
          valueFrom:
            fieldRef:
              fieldPath: metadata.annotations['ceph.kubernetes.progamesigner.dev/osd-lvm-vg']
        - name: CEPH_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.labels['ceph.kubernetes.progamesigner.dev/osd']
        resources:
          requests:
            cpu: 1000m
            memory: 2Gi
        securityContext:
          privileged: true
        volumeMounts:
        - name: conf
          mountPath: /etc/ceph
          readOnly: true
        - name: data
          mountPath: /var/lib/ceph
        - name: dev
          mountPath: /dev
        - name: run-ceph
          mountPath: /run/ceph
        - name: run-lvm
          mountPath: /run/lvm
        - name: run-udev
          mountPath: /run/udev
      containers:
      - name: osd
        image: ceph/ceph:latest
        command:
        - sh
        - -c
        - |
          set -ex;

          CEPH_FSID=$(cat /var/lib/ceph/osd/ceph-${CEPH_NAME}/fsid);

          ceph-volume lvm activate ${CEPH_NAME} ${CEPH_FSID} --no-systemd;

          exec ceph-osd --foreground --id=${CEPH_NAME} --setgroup=ceph --setuser=ceph;
        env:
        - name: CEPH_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.labels['ceph.kubernetes.progamesigner.dev/osd']
        resources:
          limits:
            cpu: 300m
            memory: 16Gi
          requests:
            cpu: 100m
            memory: 2Gi
        securityContext:
          privileged: true
        volumeMounts:
        - name: conf
          mountPath: /etc/ceph
          readOnly: true
        - name: data
          mountPath: /var/lib/ceph
        - name: dev
          mountPath: /dev
        - name: run-lvm
          mountPath: /run/lvm
      priorityClassName: system-cluster-critical
      serviceAccountName: ceph
      volumes:
      - name: ceph
        hostPath:
          path: /etc/ceph
      - name: ceph-conf
        configMap:
          name: ceph
          items:
          - key: ceph.conf
            path: ceph.conf
      - name: conf
        emptyDir: {}
      - name: data
        hostPath:
          path: /var/lib/ceph
      - name: dev
        hostPath:
          path: /dev
      - name: run-ceph
        emptyDir: {}
      - name: run-lvm
        hostPath:
          path: /run/lvm
      - name: run-udev
        hostPath:
          path: /run/udev
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app.kubernetes.io/component: osd
    app.kubernetes.io/name: ceph
    app.kubernetes.io/part-of: kubernetes
  name: ceph-osd-27a
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/component: osd
      app.kubernetes.io/name: ceph
      app.kubernetes.io/part-of: kubernetes
  template:
    metadata:
      annotations:
        ceph.kubernetes.progamesigner.dev/osd-lvm-lg: ceph-osd27a-lv
        ceph.kubernetes.progamesigner.dev/osd-lvm-vg: ceph-vg
      labels:
        app.kubernetes.io/component: osd
        app.kubernetes.io/name: ceph
        app.kubernetes.io/part-of: kubernetes
        ceph.kubernetes.progamesigner.dev/osd: '29'
    spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: osd.ceph.kubernetes.progamesigner.dev/27a
                operator: Exists
      automountServiceAccountToken: true
      hostIPC: true
      initContainers:
      - name: chown
        image: busybox:latest
        command:
        - sh
        - -c
        - |
          set -ex;

          cp -LRv /mnt/ceph/*.keyring /etc/ceph/;
          cp -LRv /mnt/ceph-conf/ceph.conf /etc/ceph/ceph.conf;

          mkdir -p /var/lib/ceph/osd/ceph-${CEPH_NAME};

          chown -R 167:167 /etc/ceph;
          chown -R 167:167 /var/lib/ceph/osd/ceph-${CEPH_NAME};
        env:
        - name: CEPH_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.labels['ceph.kubernetes.progamesigner.dev/osd']
        resources:
          requests:
            cpu: 1m
            memory: 1Mi
        volumeMounts:
        - name: ceph
          mountPath: /mnt/ceph
          readOnly: true
        - name: ceph-conf
          mountPath: /mnt/ceph-conf
          readOnly: true
        - name: conf
          mountPath: /etc/ceph
        - name: data
          mountPath: /var/lib/ceph
      - name: setup
        image: ceph/ceph:latest
        command:
        - sh
        - -c
        - |
          set -ex;

          while ! ceph mon dump; do
            echo "Waiting for mon to be ready ...";
            sleep 5;
          done

          if [ ! -f /var/lib/ceph/osd/ceph-${CEPH_NAME}/fsid ]; then
            ceph-volume lvm prepare --data ${CEPH_LVM_VG}/${CEPH_LVM_LG} --dmcrypt --osd-id ${CEPH_NAME} --no-systemd;
            sleep 5;
            echo $(ceph-volume lvm list --format json | jq -r --arg osd "${CEPH_NAME}" 'getpath([$osd,0,"tags","ceph.osd_fsid"])') > /var/lib/ceph/osd/ceph-${CEPH_NAME}/fsid;
          fi
        env:
        - name: CEPH_LVM_LG
          valueFrom:
            fieldRef:
              fieldPath: metadata.annotations['ceph.kubernetes.progamesigner.dev/osd-lvm-lg']
        - name: CEPH_LVM_VG
          valueFrom:
            fieldRef:
              fieldPath: metadata.annotations['ceph.kubernetes.progamesigner.dev/osd-lvm-vg']
        - name: CEPH_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.labels['ceph.kubernetes.progamesigner.dev/osd']
        resources:
          requests:
            cpu: 1000m
            memory: 2Gi
        securityContext:
          privileged: true
        volumeMounts:
        - name: conf
          mountPath: /etc/ceph
          readOnly: true
        - name: data
          mountPath: /var/lib/ceph
        - name: dev
          mountPath: /dev
        - name: run-ceph
          mountPath: /run/ceph
        - name: run-lvm
          mountPath: /run/lvm
        - name: run-udev
          mountPath: /run/udev
      containers:
      - name: osd
        image: ceph/ceph:latest
        command:
        - sh
        - -c
        - |
          set -ex;

          CEPH_FSID=$(cat /var/lib/ceph/osd/ceph-${CEPH_NAME}/fsid);

          ceph-volume lvm activate ${CEPH_NAME} ${CEPH_FSID} --no-systemd;

          exec ceph-osd --foreground --id=${CEPH_NAME} --setgroup=ceph --setuser=ceph;
        env:
        - name: CEPH_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.labels['ceph.kubernetes.progamesigner.dev/osd']
        resources:
          limits:
            cpu: 300m
            memory: 8Gi
          requests:
            cpu: 100m
            memory: 2Gi
        securityContext:
          privileged: true
        volumeMounts:
        - name: conf
          mountPath: /etc/ceph
          readOnly: true
        - name: data
          mountPath: /var/lib/ceph
        - name: dev
          mountPath: /dev
        - name: run-lvm
          mountPath: /run/lvm
      priorityClassName: system-cluster-critical
      serviceAccountName: ceph
      volumes:
      - name: ceph
        hostPath:
          path: /etc/ceph
      - name: ceph-conf
        configMap:
          name: ceph
          items:
          - key: ceph.conf
            path: ceph.conf
      - name: conf
        emptyDir: {}
      - name: data
        hostPath:
          path: /var/lib/ceph
      - name: dev
        hostPath:
          path: /dev
      - name: run-ceph
        emptyDir: {}
      - name: run-lvm
        hostPath:
          path: /run/lvm
      - name: run-udev
        hostPath:
          path: /run/udev
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app.kubernetes.io/component: cephfs-provisioner
    app.kubernetes.io/name: ceph-csi
    app.kubernetes.io/part-of: kubernetes
  name: ceph-csi-cephfs-provisioner
spec:
  replicas: 3
  selector:
    matchLabels:
      app.kubernetes.io/component: cephfs-provisioner
      app.kubernetes.io/name: ceph-csi
      app.kubernetes.io/part-of: kubernetes
  template:
    metadata:
      labels:
        app.kubernetes.io/component: cephfs-provisioner
        app.kubernetes.io/name: ceph-csi
        app.kubernetes.io/part-of: kubernetes
    spec:
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: app.kubernetes.io/component
                operator: In
                values:
                - cephfs-provisioner
              - key: app.kubernetes.io/name
                operator: In
                values:
                - ceph-csi
              - key: app.kubernetes.io/part-of
                operator: In
                values:
                - kubernetes
            topologyKey: kubernetes.io/hostname
      automountServiceAccountToken: true
      initContainers:
      - name: chown
        image: busybox:latest
        command:
        - sh
        - -c
        - |
          set -ex;

          cp -LRv /mnt/ceph/*.keyring /etc/ceph/;
          cp -LRv /mnt/ceph-conf/ceph.conf /etc/ceph/ceph.conf;
          cp -LRv /mnt/ceph-csi-conf/* /etc/ceph-csi-config/;

          touch /etc/ceph/keyring;

          chown -R 167:167 /etc/ceph;
          chown -R 167:167 /etc/ceph-csi-config;
        resources:
          requests:
            cpu: 1m
            memory: 1Mi
        volumeMounts:
        - name: ceph
          mountPath: /mnt/ceph
          readOnly: true
        - name: ceph-conf
          mountPath: /mnt/ceph-conf
          readOnly: true
        - name: ceph-csi-conf
          mountPath: /mnt/ceph-csi-conf
          readOnly: true
        - name: conf
          mountPath: /etc/ceph
        - name: conf-csi
          mountPath: /etc/ceph-csi-config
      containers:
      - name: ceph-csi
        image: ceph/csi:latest
        args:
        - --controllerserver=true
        - --csi-addons-endpoint=$(CSI_ADDONS_ADDRESS)
        - --drivername=cephfs.csi.ceph.com
        - --enable-fencing=true
        - --endpoint=$(CSI_PROVISIONER_ADDRESS)
        - --nodeid=$(NODE_ID)
        - --pidlimit=-1
        - --type=cephfs
        - --v=5
        env:
        - name: CSI_ADDONS_ADDRESS
          value: unix:///csi/csi-addons.sock
        - name: CSI_PROVISIONER_ADDRESS
          value: unix:///csi/csi-provisioner.sock
        - name: NODE_ID
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        resources:
          limits:
            cpu: 300m
            memory: 512Mi
          requests:
            cpu: 100m
            memory: 64Mi
        volumeMounts:
        - name: conf
          mountPath: /etc/ceph
        - name: conf-csi
          mountPath: /etc/ceph-csi-config
          readOnly: true
        - name: dev
          mountPath: /dev
        - name: keys
          mountPath: /tmp/csi/keys
        - name: modules
          mountPath: /lib/modules
          readOnly: true
        - name: socket
          mountPath: /csi
        - name: sys
          mountPath: /sys
      - name: ceph-csi-prometheus
        image: ceph/csi:latest
        args:
        - --endpoint=$(CSI_ADDRESS)
        - --metricsport=8680
        - --type=liveness
        env:
        - name: CSI_ADDRESS
          value: unix:///csi/csi-provisioner.sock
        - name: POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        ports:
        - name: metrics
          containerPort: 8680
          protocol: TCP
        resources:
          limits:
            cpu: 300m
            memory: 512Mi
          requests:
            cpu: 100m
            memory: 64Mi
        volumeMounts:
        - name: socket
          mountPath: /csi
      - name: csi-attacher
        image: csi/attacher:latest
        args:
        - --csi-address=$(CSI_ADDRESS)
        - --leader-election=true
        - --http-endpoint=$(POD_IP):8090
        - --v=1
        env:
        - name: CSI_ADDRESS
          value: unix:///csi/csi-provisioner.sock
        - name: POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        ports:
        - name: attacher
          containerPort: 8090
          protocol: TCP
        resources:
          limits:
            cpu: 300m
            memory: 512Mi
          requests:
            cpu: 100m
            memory: 64Mi
        volumeMounts:
        - name: socket
          mountPath: /csi
      - name: csi-provisioner
        image: csi/provisioner:latest
        args:
        - --csi-address=$(CSI_ADDRESS)
        - --extra-create-metadata=true
        - --feature-gates=HonorPVReclaimPolicy=true
        - --http-endpoint=$(POD_IP):8091
        - --leader-election=true
        - --prevent-volume-mode-conversion=true
        - --v=1
        env:
        - name: CSI_ADDRESS
          value: unix:///csi/csi-provisioner.sock
        - name: POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        ports:
        - name: provisioner
          containerPort: 8091
          protocol: TCP
        resources:
          limits:
            cpu: 300m
            memory: 512Mi
          requests:
            cpu: 100m
            memory: 64Mi
        volumeMounts:
        - name: socket
          mountPath: /csi
      - name: csi-resizer
        image: csi/resizer:latest
        args:
        - --csi-address=$(CSI_ADDRESS)
        - --leader-election=true
        - --handle-volume-inuse-error=false
        - --feature-gates=RecoverVolumeExpansionFailure=true
        - --http-endpoint=$(POD_IP):8092
        - --v=1
        env:
        - name: CSI_ADDRESS
          value: unix:///csi/csi-provisioner.sock
        - name: POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        ports:
        - name: resizer
          containerPort: 8092
          protocol: TCP
        resources:
          limits:
            cpu: 300m
            memory: 512Mi
          requests:
            cpu: 100m
            memory: 64Mi
        volumeMounts:
        - name: socket
          mountPath: /csi
      - name: csi-snapshotter
        image: csi/snapshotter:latest
        args:
        - --csi-address=$(CSI_ADDRESS)
        - --extra-create-metadata=true
        - --feature-gates=CSIVolumeGroupSnapshot=true
        - --http-endpoint=$(POD_IP):8093
        - --leader-election=true
        - --v=1
        env:
        - name: CSI_ADDRESS
          value: unix:///csi/csi-provisioner.sock
        - name: POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        ports:
        - name: snapshotter
          containerPort: 8093
          protocol: TCP
        resources:
          limits:
            cpu: 300m
            memory: 512Mi
          requests:
            cpu: 100m
            memory: 64Mi
        volumeMounts:
        - name: socket
          mountPath: /csi
      priorityClassName: system-cluster-critical
      serviceAccountName: ceph-csi-cephfs-provisioner
      volumes:
      - name: ceph
        hostPath:
          path: /etc/ceph
      - name: ceph-conf
        configMap:
          name: ceph
          items:
          - key: ceph.conf
            path: ceph.conf
      - name: ceph-csi-conf
        configMap:
          name: ceph-csi
          items:
          - key: config.json
            path: config.json
      - name: conf
        emptyDir: {}
      - name: conf-csi
        emptyDir: {}
      - name: dev
        hostPath:
          path: /dev
      - name: keys
        emptyDir:
          medium: Memory
      - name: modules
        hostPath:
          path: /lib/modules
      - name: socket
        emptyDir:
          medium: Memory
      - name: sys
        hostPath:
          path: /sys
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  labels:
    app.kubernetes.io/component: cephfs-nodeplugin
    app.kubernetes.io/name: ceph-csi
    app.kubernetes.io/part-of: kubernetes
  name: ceph-csi-cephfs-nodeplugin
spec:
  selector:
    matchLabels:
      app.kubernetes.io/component: cephfs-nodeplugin
      app.kubernetes.io/name: ceph-csi
      app.kubernetes.io/part-of: kubernetes
  template:
    metadata:
      labels:
        app.kubernetes.io/component: cephfs-nodeplugin
        app.kubernetes.io/name: ceph-csi
        app.kubernetes.io/part-of: kubernetes
    spec:
      automountServiceAccountToken: true
      initContainers:
      - name: chown
        image: busybox:latest
        command:
        - sh
        - -c
        - |
          set -ex;

          cp -LRv /mnt/ceph/*.keyring /etc/ceph/;
          cp -LRv /mnt/ceph-conf/ceph.conf /etc/ceph/ceph.conf;
          cp -LRv /mnt/ceph-csi-conf/* /etc/ceph-csi-config/;

          touch /etc/ceph/keyring;

          chown -R 167:167 /etc/ceph;
          chown -R 167:167 /etc/ceph-csi-config;
        resources:
          requests:
            cpu: 1m
            memory: 1Mi
        volumeMounts:
        - name: ceph
          mountPath: /mnt/ceph
          readOnly: true
        - name: ceph-conf
          mountPath: /mnt/ceph-conf
          readOnly: true
        - name: ceph-csi-conf
          mountPath: /mnt/ceph-csi-conf
          readOnly: true
        - name: conf
          mountPath: /etc/ceph
        - name: conf-csi
          mountPath: /etc/ceph-csi-config
      containers:
      - name: ceph-csi
        image: ceph/csi:latest
        args:
        - --csi-addons-endpoint=$(CSI_ADDONS_ADDRESS)
        - --drivername=cephfs.csi.ceph.com
        - --enable-fencing=true
        - --endpoint=$(CSI_ADDRESS)
        - --nodeid=$(NODE_ID)
        - --nodeserver=true
        - --pluginpath=/var/lib/kubelet/plugins
        - --stagingpath=/var/lib/kubelet/plugins/kubernetes.io/csi/
        - --type=cephfs
        - --v=5
        env:
        - name: CSI_ADDONS_ADDRESS
          value: unix:///csi/csi-addons.sock
        - name: CSI_ADDRESS
          value: unix:///csi/csi.sock
        - name: KUBERNETES_SERVICE_HOST
          valueFrom:
            configMapKeyRef:
              name: kubernetes
              key: KUBERNETES_SERVICE_HOST
        - name: KUBERNETES_SERVICE_PORT
          valueFrom:
            configMapKeyRef:
              name: kubernetes
              key: KUBERNETES_SERVICE_PORT
        - name: NODE_ID
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        resources:
          limits:
            cpu: 300m
            memory: 512Mi
          requests:
            cpu: 100m
            memory: 32Mi
        securityContext:
          allowPrivilegeEscalation: true
          capabilities:
            add:
            - SYS_ADMIN
          privileged: true
        volumeMounts:
        - name: conf
          mountPath: /etc/ceph
          readOnly: true
        - name: conf-csi
          mountPath: /etc/ceph-csi-config
          readOnly: true
        - name: dev
          mountPath: /dev
        - name: keys
          mountPath: /tmp/csi/keys
        - name: logs
          mountPath: /var/log/ceph
        - name: modules
          mountPath: /lib/modules
          readOnly: true
        - name: mount
          mountPath: /run/mount
        - name: plugins
          mountPath: /var/lib/kubelet/plugins
          mountPropagation: Bidirectional
        - name: pods
          mountPath: /var/lib/kubelet/pods
          mountPropagation: Bidirectional
        - name: selinux
          mountPath: /etc/selinux
          readOnly: true
        - name: socket
          mountPath: /csi
        - name: sys
          mountPath: /sys
      - name: ceph-csi-prometheus
        image: ceph/csi:latest
        args:
        - --endpoint=$(CSI_ADDRESS)
        - --metricsport=8681
        - --type=liveness
        env:
        - name: CSI_ADDRESS
          value: unix:///csi/csi.sock
        - name: POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        ports:
        - name: metrics
          containerPort: 8681
          protocol: TCP
        resources:
          limits:
            cpu: 300m
            memory: 512Mi
          requests:
            cpu: 100m
            memory: 64Mi
        volumeMounts:
        - name: socket
          mountPath: /csi
      - name: csi-registrar
        image: csi/registrar:latest
        args:
        - --csi-address=$(CSI_ADDRESS)
        - --kubelet-registration-path=/var/lib/kubelet/plugins/cephfs.csi.ceph.com/csi.sock
        - --v=1
        env:
        - name: CSI_ADDRESS
          value: unix:///csi/csi.sock
        - name: KUBE_NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        resources:
          limits:
            cpu: 300m
            memory: 512Mi
          requests:
            cpu: 100m
            memory: 64Mi
        securityContext:
          allowPrivilegeEscalation: true
          privileged: true
        volumeMounts:
        - name: socket
          mountPath: /csi
        - name: registration
          mountPath: /registration
      hostNetwork: true
      hostPID: true
      priorityClassName: system-cluster-critical
      serviceAccountName: ceph-csi-cephfs-nodeplugin
      volumes:
      - name: ceph
        hostPath:
          path: /etc/ceph
      - name: ceph-conf
        configMap:
          name: ceph
          items:
          - key: ceph.conf
            path: ceph.conf
      - name: ceph-csi-conf
        configMap:
          name: ceph-csi
          items:
          - key: config.json
            path: config.json
      - name: conf
        emptyDir: {}
      - name: conf-csi
        emptyDir: {}
      - name: dev
        hostPath:
          path: /dev
      - name: keys
        emptyDir:
          medium: Memory
      - name: logs
        hostPath:
          path: /var/log/ceph
          type: DirectoryOrCreate
      - name: modules
        hostPath:
          path: /lib/modules
      - name: mount
        hostPath:
          path: /run/mount
      - name: plugins
        hostPath:
          path: /var/lib/kubelet/plugins
          type: DirectoryOrCreate
      - name: pods
        hostPath:
          path: /var/lib/kubelet/pods
          type: DirectoryOrCreate
      - name: registration
        hostPath:
          path: /var/lib/kubelet/plugins_registry/
          type: DirectoryOrCreate
      - name: selinux
        hostPath:
          path: /etc/selinux
      - name: socket
        hostPath:
          path: /var/lib/kubelet/plugins/cephfs.csi.ceph.com
          type: DirectoryOrCreate
      - name: sys
        hostPath:
          path: /sys
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app.kubernetes.io/component: rbd-provisioner
    app.kubernetes.io/name: ceph-csi
    app.kubernetes.io/part-of: kubernetes
  name: ceph-csi-rbd-provisioner
spec:
  replicas: 3
  selector:
    matchLabels:
      app.kubernetes.io/component: rbd-provisioner
      app.kubernetes.io/name: ceph-csi
      app.kubernetes.io/part-of: kubernetes
  template:
    metadata:
      labels:
        app.kubernetes.io/component: rbd-provisioner
        app.kubernetes.io/name: ceph-csi
        app.kubernetes.io/part-of: kubernetes
    spec:
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: app.kubernetes.io/component
                operator: In
                values:
                - rbd-provisioner
              - key: app.kubernetes.io/name
                operator: In
                values:
                - ceph-csi
              - key: app.kubernetes.io/part-of
                operator: In
                values:
                - kubernetes
            topologyKey: kubernetes.io/hostname
      automountServiceAccountToken: true
      initContainers:
      - name: chown
        image: busybox:latest
        command:
        - sh
        - -c
        - |
          set -ex;

          cp -LRv /mnt/ceph/*.keyring /etc/ceph/;
          cp -LRv /mnt/ceph-conf/ceph.conf /etc/ceph/ceph.conf;
          cp -LRv /mnt/ceph-csi-conf/* /etc/ceph-csi-config/;

          touch /etc/ceph/keyring;

          chown -R 167:167 /etc/ceph;
          chown -R 167:167 /etc/ceph-csi-config;
        resources:
          requests:
            cpu: 1m
            memory: 1Mi
        volumeMounts:
        - name: ceph
          mountPath: /mnt/ceph
          readOnly: true
        - name: ceph-conf
          mountPath: /mnt/ceph-conf
          readOnly: true
        - name: ceph-csi-conf
          mountPath: /mnt/ceph-csi-conf
          readOnly: true
        - name: conf
          mountPath: /etc/ceph
        - name: conf-csi
          mountPath: /etc/ceph-csi-config
      containers:
      - name: ceph-csi
        image: ceph/csi:latest
        args:
        - --controllerserver=true
        - --csi-addons-endpoint=$(CSI_ADDONS_ADDRESS)
        - --drivername=rbd.csi.ceph.com
        - --enable-fencing=true
        - --endpoint=$(CSI_PROVISIONER_ADDRESS)
        - --nodeid=$(NODE_ID)
        - --pidlimit=-1
        - --type=rbd
        - --v=5
        env:
        - name: CSI_ADDONS_ADDRESS
          value: unix:///csi/csi-addons.sock
        - name: CSI_PROVISIONER_ADDRESS
          value: unix:///csi/csi-provisioner.sock
        - name: NODE_ID
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        resources:
          limits:
            cpu: 300m
            memory: 512Mi
          requests:
            cpu: 100m
            memory: 64Mi
        volumeMounts:
        - name: conf
          mountPath: /etc/ceph
        - name: conf-csi
          mountPath: /etc/ceph-csi-config
          readOnly: true
        - name: dev
          mountPath: /dev
        - name: keys
          mountPath: /tmp/csi/keys
        - name: modules
          mountPath: /lib/modules
          readOnly: true
        - name: socket
          mountPath: /csi
        - name: sys
          mountPath: /sys
      - name: ceph-csi-controller
        image: ceph/csi:latest
        args:
        - --drivername=rbd.csi.ceph.com
        - --drivernamespace=$(DRIVER_NAMESPACE)
        - --type=controller
        - --v=5
        env:
        - name: DRIVER_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        resources:
          limits:
            cpu: 300m
            memory: 512Mi
          requests:
            cpu: 100m
            memory: 64Mi
        volumeMounts:
        - name: conf
          mountPath: /etc/ceph
          readOnly: true
        - name: conf-csi
          mountPath: /etc/ceph-csi-config
          readOnly: true
        - name: keys
          mountPath: /tmp/csi/keys
      - name: ceph-csi-prometheus
        image: ceph/csi:latest
        args:
        - --endpoint=$(CSI_ADDRESS)
        - --metricsport=8680
        - --type=liveness
        env:
        - name: CSI_ADDRESS
          value: unix:///csi/csi-provisioner.sock
        - name: POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        ports:
        - name: metrics
          containerPort: 8680
          protocol: TCP
        resources:
          limits:
            cpu: 300m
            memory: 512Mi
          requests:
            cpu: 100m
            memory: 64Mi
        volumeMounts:
        - name: socket
          mountPath: /csi
      - name: csi-attacher
        image: csi/attacher:latest
        args:
        - --csi-address=$(CSI_ADDRESS)
        - --leader-election=true
        - --default-fstype=ext4
        - --http-endpoint=$(POD_IP):8090
        - --v=1
        env:
        - name: CSI_ADDRESS
          value: unix:///csi/csi-provisioner.sock
        - name: POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        ports:
        - name: attacher
          containerPort: 8090
          protocol: TCP
        resources:
          limits:
            cpu: 300m
            memory: 512Mi
          requests:
            cpu: 100m
            memory: 64Mi
        volumeMounts:
        - name: socket
          mountPath: /csi
      - name: csi-provisioner
        image: csi/provisioner:latest
        args:
        - --csi-address=$(CSI_ADDRESS)
        - --default-fstype=ext4
        - --extra-create-metadata=true
        - --feature-gates=HonorPVReclaimPolicy=true
        - --http-endpoint=$(POD_IP):8091
        - --immediate-topology=false
        - --leader-election=true
        - --v=1
        env:
        - name: CSI_ADDRESS
          value: unix:///csi/csi-provisioner.sock
        - name: POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        ports:
        - name: provisioner
          containerPort: 8091
          protocol: TCP
        resources:
          limits:
            cpu: 300m
            memory: 512Mi
          requests:
            cpu: 100m
            memory: 64Mi
        volumeMounts:
        - name: socket
          mountPath: /csi
      - name: csi-resizer
        image: csi/resizer:latest
        args:
        - --csi-address=$(CSI_ADDRESS)
        - --leader-election=true
        - --handle-volume-inuse-error=false
        - --feature-gates=RecoverVolumeExpansionFailure=true
        - --http-endpoint=$(POD_IP):8092
        - --v=1
        env:
        - name: CSI_ADDRESS
          value: unix:///csi/csi-provisioner.sock
        - name: POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        ports:
        - name: resizer
          containerPort: 8092
          protocol: TCP
        resources:
          limits:
            cpu: 300m
            memory: 512Mi
          requests:
            cpu: 100m
            memory: 64Mi
        volumeMounts:
        - name: socket
          mountPath: /csi
      - name: csi-snapshotter
        image: csi/snapshotter:latest
        args:
        - --csi-address=$(CSI_ADDRESS)
        - --extra-create-metadata=true
        - --feature-gates=CSIVolumeGroupSnapshot=true
        - --http-endpoint=$(POD_IP):8093
        - --leader-election=true
        - --v=1
        env:
        - name: CSI_ADDRESS
          value: unix:///csi/csi-provisioner.sock
        - name: POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        ports:
        - name: snapshotter
          containerPort: 8093
          protocol: TCP
        resources:
          limits:
            cpu: 300m
            memory: 512Mi
          requests:
            cpu: 100m
            memory: 64Mi
        volumeMounts:
        - name: socket
          mountPath: /csi
      priorityClassName: system-cluster-critical
      serviceAccountName: ceph-csi-rbd-provisioner
      volumes:
      - name: ceph
        hostPath:
          path: /etc/ceph
      - name: ceph-conf
        configMap:
          name: ceph
          items:
          - key: ceph.conf
            path: ceph.conf
      - name: ceph-csi-conf
        configMap:
          name: ceph-csi
          items:
          - key: config.json
            path: config.json
      - name: conf
        emptyDir: {}
      - name: conf-csi
        emptyDir: {}
      - name: dev
        hostPath:
          path: /dev
      - name: keys
        emptyDir:
          medium: Memory
      - name: modules
        hostPath:
          path: /lib/modules
      - name: socket
        emptyDir:
          medium: Memory
      - name: sys
        hostPath:
          path: /sys
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  labels:
    app.kubernetes.io/component: rbd-nodeplugin
    app.kubernetes.io/name: ceph-csi
    app.kubernetes.io/part-of: kubernetes
  name: ceph-csi-rbd-nodeplugin
spec:
  selector:
    matchLabels:
      app.kubernetes.io/component: rbd-nodeplugin
      app.kubernetes.io/name: ceph-csi
      app.kubernetes.io/part-of: kubernetes
  template:
    metadata:
      labels:
        app.kubernetes.io/component: rbd-nodeplugin
        app.kubernetes.io/name: ceph-csi
        app.kubernetes.io/part-of: kubernetes
    spec:
      automountServiceAccountToken: true
      initContainers:
      - name: chown
        image: busybox:latest
        command:
        - sh
        - -c
        - |
          set -ex;

          cp -LRv /mnt/ceph/*.keyring /etc/ceph/;
          cp -LRv /mnt/ceph-conf/ceph.conf /etc/ceph/ceph.conf;
          cp -LRv /mnt/ceph-csi-conf/* /etc/ceph-csi-config/;

          touch /etc/ceph/keyring;

          chown -R 167:167 /etc/ceph;
          chown -R 167:167 /etc/ceph-csi-config;
        resources:
          requests:
            cpu: 1m
            memory: 1Mi
        volumeMounts:
        - name: ceph
          mountPath: /mnt/ceph
          readOnly: true
        - name: ceph-conf
          mountPath: /mnt/ceph-conf
          readOnly: true
        - name: ceph-csi-conf
          mountPath: /mnt/ceph-csi-conf
          readOnly: true
        - name: conf
          mountPath: /etc/ceph
        - name: conf-csi
          mountPath: /etc/ceph-csi-config
      containers:
      - name: ceph-csi
        image: ceph/csi:latest
        args:
        - --csi-addons-endpoint=$(CSI_ADDONS_ADDRESS)
        - --drivername=rbd.csi.ceph.com
        - --enable-fencing=true
        - --endpoint=$(CSI_ADDRESS)
        - --nodeid=$(NODE_ID)
        - --nodeserver=true
        - --pluginpath=/var/lib/kubelet/plugins
        - --stagingpath=/var/lib/kubelet/plugins/kubernetes.io/csi/
        - --type=rbd
        - --v=5
        env:
        - name: CSI_ADDONS_ADDRESS
          value: unix:///csi/csi-addons.sock
        - name: CSI_ADDRESS
          value: unix:///csi/csi.sock
        - name: KUBERNETES_SERVICE_HOST
          valueFrom:
            configMapKeyRef:
              name: kubernetes
              key: KUBERNETES_SERVICE_HOST
        - name: KUBERNETES_SERVICE_PORT
          valueFrom:
            configMapKeyRef:
              name: kubernetes
              key: KUBERNETES_SERVICE_PORT
        - name: NODE_ID
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        resources:
          limits:
            cpu: 300m
            memory: 512Mi
          requests:
            cpu: 100m
            memory: 32Mi
        securityContext:
          allowPrivilegeEscalation: true
          capabilities:
            add:
            - SYS_ADMIN
          privileged: true
        volumeMounts:
        - name: conf
          mountPath: /etc/ceph
          readOnly: true
        - name: conf-csi
          mountPath: /etc/ceph-csi-config
          readOnly: true
        - name: dev
          mountPath: /dev
        - name: keys
          mountPath: /tmp/csi/keys
        - name: logs
          mountPath: /var/log/ceph
        - name: modules
          mountPath: /lib/modules
          readOnly: true
        - name: mount
          mountPath: /run/mount
        - name: plugins
          mountPath: /var/lib/kubelet/plugins
          mountPropagation: Bidirectional
        - name: pods
          mountPath: /var/lib/kubelet/pods
          mountPropagation: Bidirectional
        - name: selinux
          mountPath: /etc/selinux
          readOnly: true
        - name: socket
          mountPath: /csi
        - name: sys
          mountPath: /sys
      - name: ceph-csi-prometheus
        image: ceph/csi:latest
        args:
        - --endpoint=$(CSI_ADDRESS)
        - --metricsport=8682
        - --type=liveness
        env:
        - name: CSI_ADDRESS
          value: unix:///csi/csi.sock
        - name: POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        ports:
        - name: metrics
          containerPort: 8682
          protocol: TCP
        resources:
          limits:
            cpu: 300m
            memory: 512Mi
          requests:
            cpu: 100m
            memory: 64Mi
        volumeMounts:
        - name: socket
          mountPath: /csi
      - name: csi-registrar
        image: csi/registrar:latest
        args:
        - --csi-address=$(CSI_ADDRESS)
        - --kubelet-registration-path=/var/lib/kubelet/plugins/rbd.csi.ceph.com/csi.sock
        - --v=1
        env:
        - name: CSI_ADDRESS
          value: unix:///csi/csi.sock
        - name: KUBE_NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        resources:
          limits:
            cpu: 300m
            memory: 512Mi
          requests:
            cpu: 100m
            memory: 64Mi
        securityContext:
          allowPrivilegeEscalation: true
          privileged: true
        volumeMounts:
        - name: socket
          mountPath: /csi
        - name: registration
          mountPath: /registration
      hostNetwork: true
      hostPID: true
      priorityClassName: system-cluster-critical
      serviceAccountName: ceph-csi-rbd-nodeplugin
      volumes:
      - name: ceph
        hostPath:
          path: /etc/ceph
      - name: ceph-conf
        configMap:
          name: ceph
          items:
          - key: ceph.conf
            path: ceph.conf
      - name: ceph-csi-conf
        configMap:
          name: ceph-csi
          items:
          - key: config.json
            path: config.json
      - name: conf
        emptyDir: {}
      - name: conf-csi
        emptyDir: {}
      - name: dev
        hostPath:
          path: /dev
      - name: keys
        emptyDir:
          medium: Memory
      - name: logs
        hostPath:
          path: /var/log/ceph
          type: DirectoryOrCreate
      - name: modules
        hostPath:
          path: /lib/modules
      - name: mount
        hostPath:
          path: /run/mount
      - name: plugins
        hostPath:
          path: /var/lib/kubelet/plugins
          type: DirectoryOrCreate
      - name: pods
        hostPath:
          path: /var/lib/kubelet/pods
          type: DirectoryOrCreate
      - name: registration
        hostPath:
          path: /var/lib/kubelet/plugins_registry/
          type: DirectoryOrCreate
      - name: selinux
        hostPath:
          path: /etc/selinux
      - name: socket
        hostPath:
          path: /var/lib/kubelet/plugins/rbd.csi.ceph.com
          type: DirectoryOrCreate
      - name: sys
        hostPath:
          path: /sys
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app.kubernetes.io/component: nfs-provisioner
    app.kubernetes.io/name: ceph-csi
    app.kubernetes.io/part-of: kubernetes
  name: ceph-csi-nfs-provisioner
spec:
  replicas: 3
  selector:
    matchLabels:
      app.kubernetes.io/component: nfs-provisioner
      app.kubernetes.io/name: ceph-csi
      app.kubernetes.io/part-of: kubernetes
  template:
    metadata:
      labels:
        app.kubernetes.io/component: nfs-provisioner
        app.kubernetes.io/name: ceph-csi
        app.kubernetes.io/part-of: kubernetes
    spec:
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: app.kubernetes.io/component
                operator: In
                values:
                - nfs-provisioner
              - key: app.kubernetes.io/name
                operator: In
                values:
                - ceph-csi
              - key: app.kubernetes.io/part-of
                operator: In
                values:
                - kubernetes
            topologyKey: kubernetes.io/hostname
      automountServiceAccountToken: true
      initContainers:
      - name: chown
        image: busybox:latest
        command:
        - sh
        - -c
        - |
          set -ex;

          cp -LRv /mnt/ceph/*.keyring /etc/ceph/;
          cp -LRv /mnt/ceph-conf/ceph.conf /etc/ceph/ceph.conf;
          cp -LRv /mnt/ceph-csi-conf/* /etc/ceph-csi-config/;

          touch /etc/ceph/keyring;

          chown -R 167:167 /etc/ceph;
          chown -R 167:167 /etc/ceph-csi-config;
        resources:
          requests:
            cpu: 1m
            memory: 1Mi
        volumeMounts:
        - name: ceph
          mountPath: /mnt/ceph
          readOnly: true
        - name: ceph-conf
          mountPath: /mnt/ceph-conf
          readOnly: true
        - name: ceph-csi-conf
          mountPath: /mnt/ceph-csi-conf
          readOnly: true
        - name: conf
          mountPath: /etc/ceph
        - name: conf-csi
          mountPath: /etc/ceph-csi-config
      containers:
      - name: ceph-csi
        image: ceph/csi:latest
        args:
        - --controllerserver=true
        - --csi-addons-endpoint=$(CSI_ADDONS_ADDRESS)
        - --drivername=nfs.csi.ceph.com
        - --enable-fencing=true
        - --endpoint=$(CSI_PROVISIONER_ADDRESS)
        - --nodeid=$(NODE_ID)
        - --pidlimit=-1
        - --type=nfs
        - --v=5
        env:
        - name: CSI_ADDONS_ADDRESS
          value: unix:///csi/csi-addons.sock
        - name: CSI_PROVISIONER_ADDRESS
          value: unix:///csi/csi-provisioner.sock
        - name: NODE_ID
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        resources:
          limits:
            cpu: 300m
            memory: 512Mi
          requests:
            cpu: 100m
            memory: 64Mi
        volumeMounts:
        - name: conf
          mountPath: /etc/ceph
        - name: conf-csi
          mountPath: /etc/ceph-csi-config
          readOnly: true
        - name: dev
          mountPath: /dev
        - name: keys
          mountPath: /tmp/csi/keys
        - name: modules
          mountPath: /lib/modules
          readOnly: true
        - name: socket
          mountPath: /csi
        - name: sys
          mountPath: /sys
      - name: ceph-csi-prometheus
        image: ceph/csi:latest
        args:
        - --endpoint=$(CSI_ADDRESS)
        - --metricsport=8680
        - --type=liveness
        env:
        - name: CSI_ADDRESS
          value: unix:///csi/csi-provisioner.sock
        - name: POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        ports:
        - name: metrics
          containerPort: 8680
          protocol: TCP
        resources:
          limits:
            cpu: 300m
            memory: 512Mi
          requests:
            cpu: 100m
            memory: 64Mi
        volumeMounts:
        - name: socket
          mountPath: /csi
      - name: csi-provisioner
        image: csi/provisioner:latest
        args:
        - --csi-address=$(CSI_ADDRESS)
        - --default-fstype=ext4
        - --extra-create-metadata=true
        - --feature-gates=HonorPVReclaimPolicy=true
        - --http-endpoint=$(POD_IP):8091
        - --immediate-topology=false
        - --leader-election=true
        - --v=1
        env:
        - name: CSI_ADDRESS
          value: unix:///csi/csi-provisioner.sock
        - name: POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        ports:
        - name: provisioner
          containerPort: 8091
          protocol: TCP
        resources:
          limits:
            cpu: 300m
            memory: 512Mi
          requests:
            cpu: 100m
            memory: 64Mi
        volumeMounts:
        - name: socket
          mountPath: /csi
      - name: csi-resizer
        image: csi/resizer:latest
        args:
        - --csi-address=$(CSI_ADDRESS)
        - --leader-election=true
        - --handle-volume-inuse-error=false
        - --feature-gates=RecoverVolumeExpansionFailure=true
        - --http-endpoint=$(POD_IP):8092
        - --v=1
        env:
        - name: CSI_ADDRESS
          value: unix:///csi/csi-provisioner.sock
        - name: POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        ports:
        - name: resizer
          containerPort: 8092
          protocol: TCP
        resources:
          limits:
            cpu: 300m
            memory: 512Mi
          requests:
            cpu: 100m
            memory: 64Mi
        volumeMounts:
        - name: socket
          mountPath: /csi
      - name: csi-snapshotter
        image: csi/snapshotter:latest
        args:
        - --csi-address=$(CSI_ADDRESS)
        - --extra-create-metadata=true
        - --feature-gates=CSIVolumeGroupSnapshot=true
        - --http-endpoint=$(POD_IP):8093
        - --leader-election=true
        - --v=1
        env:
        - name: CSI_ADDRESS
          value: unix:///csi/csi-provisioner.sock
        - name: POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        ports:
        - name: snapshotter
          containerPort: 8093
          protocol: TCP
        resources:
          limits:
            cpu: 300m
            memory: 512Mi
          requests:
            cpu: 100m
            memory: 64Mi
        volumeMounts:
        - name: socket
          mountPath: /csi
      priorityClassName: system-cluster-critical
      serviceAccountName: ceph-csi-nfs-provisioner
      volumes:
      - name: ceph
        hostPath:
          path: /etc/ceph
      - name: ceph-conf
        configMap:
          name: ceph
          items:
          - key: ceph.conf
            path: ceph.conf
      - name: ceph-csi-conf
        configMap:
          name: ceph-csi
          items:
          - key: config.json
            path: config.json
      - name: conf
        emptyDir: {}
      - name: conf-csi
        emptyDir: {}
      - name: dev
        hostPath:
          path: /dev
      - name: keys
        emptyDir:
          medium: Memory
      - name: modules
        hostPath:
          path: /lib/modules
      - name: socket
        emptyDir:
          medium: Memory
      - name: sys
        hostPath:
          path: /sys
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  labels:
    app.kubernetes.io/component: nfs-nodeplugin
    app.kubernetes.io/name: ceph-csi
    app.kubernetes.io/part-of: kubernetes
  name: ceph-csi-nfs-nodeplugin
spec:
  selector:
    matchLabels:
      app.kubernetes.io/component: nfs-nodeplugin
      app.kubernetes.io/name: ceph-csi
      app.kubernetes.io/part-of: kubernetes
  template:
    metadata:
      labels:
        app.kubernetes.io/component: nfs-nodeplugin
        app.kubernetes.io/name: ceph-csi
        app.kubernetes.io/part-of: kubernetes
    spec:
      automountServiceAccountToken: true
      initContainers:
      - name: chown
        image: busybox:latest
        command:
        - sh
        - -c
        - |
          set -ex;

          cp -LRv /mnt/ceph/*.keyring /etc/ceph/;
          cp -LRv /mnt/ceph-conf/ceph.conf /etc/ceph/ceph.conf;
          cp -LRv /mnt/ceph-csi-conf/* /etc/ceph-csi-config/;

          touch /etc/ceph/keyring;

          chown -R 167:167 /etc/ceph;
          chown -R 167:167 /etc/ceph-csi-config;
        resources:
          requests:
            cpu: 1m
            memory: 1Mi
        volumeMounts:
        - name: ceph
          mountPath: /mnt/ceph
          readOnly: true
        - name: ceph-conf
          mountPath: /mnt/ceph-conf
          readOnly: true
        - name: ceph-csi-conf
          mountPath: /mnt/ceph-csi-conf
          readOnly: true
        - name: conf
          mountPath: /etc/ceph
        - name: conf-csi
          mountPath: /etc/ceph-csi-config
      containers:
      - name: ceph-csi
        image: ceph/csi:latest
        args:
        - --csi-addons-endpoint=$(CSI_ADDONS_ADDRESS)
        - --drivername=nfs.csi.ceph.com
        - --enable-fencing=true
        - --endpoint=$(CSI_ADDRESS)
        - --nodeid=$(NODE_ID)
        - --nodeserver=true
        - --pluginpath=/var/lib/kubelet/plugins
        - --stagingpath=/var/lib/kubelet/plugins/kubernetes.io/csi/
        - --type=nfs
        - --v=5
        env:
        - name: CSI_ADDONS_ADDRESS
          value: unix:///csi/csi-addons.sock
        - name: CSI_ADDRESS
          value: unix:///csi/csi.sock
        - name: KUBERNETES_SERVICE_HOST
          valueFrom:
            configMapKeyRef:
              name: kubernetes
              key: KUBERNETES_SERVICE_HOST
        - name: KUBERNETES_SERVICE_PORT
          valueFrom:
            configMapKeyRef:
              name: kubernetes
              key: KUBERNETES_SERVICE_PORT
        - name: NODE_ID
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        resources:
          limits:
            cpu: 300m
            memory: 512Mi
          requests:
            cpu: 100m
            memory: 32Mi
        securityContext:
          allowPrivilegeEscalation: true
          capabilities:
            add:
            - SYS_ADMIN
          privileged: true
        volumeMounts:
        - name: conf
          mountPath: /etc/ceph
          readOnly: true
        - name: conf-csi
          mountPath: /etc/ceph-csi-config
          readOnly: true
        - name: dev
          mountPath: /dev
        - name: keys
          mountPath: /tmp/csi/keys
        - name: logs
          mountPath: /var/log/ceph
        - name: modules
          mountPath: /lib/modules
          readOnly: true
        - name: mount
          mountPath: /run/mount
        - name: plugins
          mountPath: /var/lib/kubelet/plugins
          mountPropagation: Bidirectional
        - name: pods
          mountPath: /var/lib/kubelet/pods
          mountPropagation: Bidirectional
        - name: selinux
          mountPath: /etc/selinux
          readOnly: true
        - name: socket
          mountPath: /csi
        - name: sys
          mountPath: /sys
      - name: ceph-csi-prometheus
        image: ceph/csi:latest
        args:
        - --endpoint=$(CSI_ADDRESS)
        - --metricsport=8683
        - --type=liveness
        env:
        - name: CSI_ADDRESS
          value: unix:///csi/csi.sock
        - name: POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        ports:
        - name: metrics
          containerPort: 8683
          protocol: TCP
        resources:
          limits:
            cpu: 300m
            memory: 512Mi
          requests:
            cpu: 100m
            memory: 64Mi
        volumeMounts:
        - name: socket
          mountPath: /csi
      - name: csi-registrar
        image: csi/registrar:latest
        args:
        - --csi-address=$(CSI_ADDRESS)
        - --kubelet-registration-path=/var/lib/kubelet/plugins/nfs.csi.ceph.com/csi.sock
        - --v=1
        env:
        - name: CSI_ADDRESS
          value: unix:///csi/csi.sock
        - name: KUBE_NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        resources:
          limits:
            cpu: 300m
            memory: 512Mi
          requests:
            cpu: 100m
            memory: 64Mi
        securityContext:
          allowPrivilegeEscalation: true
          privileged: true
        volumeMounts:
        - name: socket
          mountPath: /csi
        - name: registration
          mountPath: /registration
      hostNetwork: true
      hostPID: true
      priorityClassName: system-cluster-critical
      serviceAccountName: ceph-csi-nfs-nodeplugin
      volumes:
      - name: ceph
        hostPath:
          path: /etc/ceph
      - name: ceph-conf
        configMap:
          name: ceph
          items:
          - key: ceph.conf
            path: ceph.conf
      - name: ceph-csi-conf
        configMap:
          name: ceph-csi
          items:
          - key: config.json
            path: config.json
      - name: conf
        emptyDir: {}
      - name: conf-csi
        emptyDir: {}
      - name: dev
        hostPath:
          path: /dev
      - name: keys
        emptyDir:
          medium: Memory
      - name: logs
        hostPath:
          path: /var/log/ceph
          type: DirectoryOrCreate
      - name: modules
        hostPath:
          path: /lib/modules
      - name: mount
        hostPath:
          path: /run/mount
      - name: plugins
        hostPath:
          path: /var/lib/kubelet/plugins
          type: DirectoryOrCreate
      - name: pods
        hostPath:
          path: /var/lib/kubelet/pods
          type: DirectoryOrCreate
      - name: registration
        hostPath:
          path: /var/lib/kubelet/plugins_registry/
          type: DirectoryOrCreate
      - name: selinux
        hostPath:
          path: /etc/selinux
      - name: socket
        hostPath:
          path: /var/lib/kubelet/plugins/nfs.csi.ceph.com
          type: DirectoryOrCreate
      - name: sys
        hostPath:
          path: /sys
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app.kubernetes.io/component: controller
    app.kubernetes.io/name: csi-addons
    app.kubernetes.io/part-of: kubernetes
  name: csi-addons-controller
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/component: controller
      app.kubernetes.io/name: csi-addons
      app.kubernetes.io/part-of: kubernetes
  template:
    metadata:
      labels:
        app.kubernetes.io/component: controller
        app.kubernetes.io/name: csi-addons
        app.kubernetes.io/part-of: kubernetes
    spec:
      automountServiceAccountToken: true
      containers:
      - name: controller
        image: csi-addons/controller:latest
        command:
        - /csi-addons-manager
        args:
        - --automaxprocs
        - --leader-elect
        - --namespace=$(POD_NAMESPACE)
        env:
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        ports:
        - name: metrics
          containerPort: 8443
          protocol: TCP
        livenessProbe:
          httpGet:
            path: /healthz
            port: 8081
          initialDelaySeconds: 15
          periodSeconds: 20
        readinessProbe:
          httpGet:
            path: /readyz
            port: 8081
          initialDelaySeconds: 5
        resources:
          limits:
            cpu: 1000m
            memory: 512Mi
          requests:
            cpu: 100m
            memory: 32Mi
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
      securityContext:
        runAsNonRoot: true
      serviceAccountName: csi-addons-controller
